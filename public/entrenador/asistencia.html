<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Asistencia - Entrenador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CSS Global -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
</head>

<body class="bg-gray-100">

<!-- CONFIG GLOBAL -->
<script src="../js/config.js"></script>

<!-- VALIDACIÃ“N -->
<script>
if (!localStorage.getItem("token") || localStorage.getItem("rol") !== "entrenador") {
    window.location.href = "../index.html";
}
</script>

<!-- SIDEBAR DINÃMICO -->
<div id="sidebar-container"></div>
<script src="../js/loadSidebar.js"></script>

<!-- ================================
     CONTENIDO
================================ -->
<main class="p-4 sm:p-8 md:ml-60 max-w-6xl mx-auto">

    <!-- TÃTULO -->
    <h1 class="text-2xl sm:text-3xl font-bold text-green-700 mb-6">
        Registrar Asistencia
    </h1>

    <!-- ================================
         CREAR EVENTO
    ================================ -->
    <div class="bg-white p-6 rounded-xl shadow mb-10 border-l-8 border-green-600">
        <h2 class="text-xl font-bold text-green-700 mb-4">Crear nuevo evento</h2>

        <div class="grid sm:grid-cols-2 gap-6">

            <div>
                <label class="font-semibold">Fecha del Evento</label>
                <input id="fechaEvento" type="date" class="input w-full">
            </div>

            <div>
                <label class="font-semibold">Tipo de Evento</label>
                <select id="tipoEvento" class="input w-full">
                    <option value="Entrenamiento">Entrenamiento</option>
                    <option value="Partido">Partido</option>
                    <option value="Torneo">Torneo</option>
                </select>
            </div>

        </div>

        <button onclick="crearEvento()"
            class="btn bg-green-600 hover:bg-green-700 text-white mt-4 w-full sm:w-auto">
            Crear evento
        </button>
    </div>

    <!-- ================================
         EVENTOS PROGRAMADOS
    ================================ -->
    <div class="bg-white p-6 rounded-xl shadow mb-10 border-l-8 border-blue-600">
        <h2 class="text-xl font-bold text-blue-700 mb-4">ðŸ—“ Eventos Programados</h2>

        <div class="responsive-table">
            <table class="table min-w-[600px]">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tbodyProgramados"></tbody>
            </table>
        </div>
    </div>

    <!-- ================================
         EVENTOS ANTERIORES
    ================================ -->
    <div class="bg-white p-6 rounded-xl shadow border-l-8 border-amber-600">
        <h2 class="text-xl font-bold text-amber-700 mb-4">ðŸ“˜ Eventos Anteriores</h2>

        <div class="responsive-table">
            <table class="table min-w-[600px]">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>Asistencia</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tbodyAnteriores"></tbody>
            </table>
        </div>
    </div>

</main>

<script>

// VARIABLES
const categoriaId = localStorage.getItem("categoria");
const entrenadorId = localStorage.getItem("idEntrenador");

/* ==========================================================
   1. CREAR EVENTO
========================================================== */
async function crearEvento() {
    const fechaEvento = document.getElementById("fechaEvento").value;
    const tipoEvento = document.getElementById("tipoEvento").value;

    if (!fechaEvento) {
        alert("Debe seleccionar una fecha.");
        return;
    }

    const res = await fetch(`${BASE_URL}/api/evento/crear`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            categoriaId,
            entrenadorId,
            fechaEvento,
            tipoEvento
        })
    });

    const data = await res.json();

    if (!res.ok) {
        alert("Error: " + data.error);
        return;
    }

    alert("Evento creado correctamente.");
    cargarEventos();
}

/* ==========================================================
   2. ETIQUETAS DE ESTADO
========================================================== */
function obtenerEstadoVisual(fechaStr) {
    const hoy = new Date();
    const fecha = new Date(fechaStr);

    const diff = fecha - hoy;
    const dias = Math.ceil(diff / (1000 * 60 * 60 * 24));

    if (dias === 0) return `<span class="estado verde">HOY</span>`;
    if (dias === 1) return `<span class="estado azul">MAÃ‘ANA</span>`;
    if (dias < 0) return `<span class="estado rojo">ATRASADO</span>`;

    return `<span class="estado amarillo">PRÃ“XIMO</span>`;
}

/* ==========================================================
   3. CARGAR EVENTOS
========================================================== */
async function cargarEventos() {
    const res = await fetch(`${BASE_URL}/api/evento/categoria/${categoriaId}`);
    const eventos = await res.json();

    const tbodyProgram = document.getElementById("tbodyProgramados");
    const tbodyAnt = document.getElementById("tbodyAnteriores");

    tbodyProgram.innerHTML = "";
    tbodyAnt.innerHTML = "";

    const hoy = new Date();
    const hoySinHora = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

    eventos.forEach(e => {
        const fecha = new Date(e.fechaEvento);
        const fechaTxt = fecha.toLocaleDateString("es-CL");
        const estadoVisual = obtenerEstadoVisual(e.fechaEvento);

        const esProgramado =
            !e.cerrado &&
            fecha >= hoySinHora &&
            Number(e.porcentajeAsistencia || 0) === 0;

        const esAnterior =
            e.cerrado ||
            fecha < hoySinHora ||
            Number(e.porcentajeAsistencia || 0) > 0;

        /* ================================
           EVENTOS PROGRAMADOS
        ================================ */
        if (esProgramado) {
            tbodyProgram.innerHTML += `
                <tr>
                    <td>${fechaTxt}</td>
                    <td>${e.tipoEvento}</td>
                    <td>${estadoVisual}</td>
                    <td class="text-center flex gap-2 justify-center">

                        <button onclick="verEvento('${e._id}')"
                            class="btn-sm bg-blue-600 hover:bg-blue-800 text-white">
                            Ir al evento
                        </button>

                        <button onclick="eliminarEvento('${e._id}')"
                            class="btn-sm bg-red-600 hover:bg-red-800 text-white">
                            Eliminar
                        </button>
                    </td>
                </tr>
            `;
        }

        /* ================================
           EVENTOS ANTERIORES
        ================================ */
        if (esAnterior) {
            tbodyAnt.innerHTML += `
                <tr>
                    <td>${fechaTxt}</td>
                    <td>${e.tipoEvento}</td>
                    <td>${e.porcentajeAsistencia || 0}%</td>
                    <td class="text-center flex gap-2 justify-center">

                        <button onclick="verEvento('${e._id}')"
                            class="btn-sm bg-blue-600 hover:bg-blue-800 text-white">
                            Ver
                        </button>

                        <button onclick="eliminarEvento('${e._id}')"
                            class="btn-sm bg-red-600 hover:bg-red-800 text-white">
                            Eliminar
                        </button>

                    </td>
                </tr>
            `;
        }

    });
}

/* ==========================================================
   4. VER EVENTO
========================================================== */
function verEvento(id) {
    localStorage.setItem("eventoSeleccionado", id);
    window.location.href = "./asistencia-evento.html";
}

/* ==========================================================
   5. ELIMINAR
========================================================== */
async function eliminarEvento(id) {
    if (!confirm("Â¿Eliminar este evento?")) return;

    const res = await fetch(`${BASE_URL}/api/evento/${id}`, {
        method: "DELETE"
    });

    const data = await res.json();

    if (data.error) return alert("Error: " + data.error);

    alert("Evento eliminado.");
    cargarEventos();
}

/* INICIALIZACIÃ“N */
cargarEventos();

</script>

</body>
</html>
