<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Categoría - Entrenador</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CSS Global -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
</head>

<body class="bg-gray-100">

<!-- VALIDACIÓN -->
<script>
if (!localStorage.getItem("token") || localStorage.getItem("rol") !== "entrenador") {
    window.location.href = "../index.html";
}
</script>

<script src="../js/config.js"></script>

<!-- SIDEBAR DINÁMICO -->
<div id="sidebar-container"></div>
<script src="../js/loadSidebar.js"></script>

<!-- ===============================================
     CONTENIDO PRINCIPAL
=============================================== -->
<main class="flex-1 p-6 md:p-10 md:ml-60 min-h-screen relative">

    <div class="max-w-6xl mx-auto bg-white shadow rounded-xl p-6 sm:p-8 relative z-10">

        <!-- TÍTULO -->
        <h1 class="text-2xl sm:text-3xl font-bold text-green-700 mb-4">
            Mi Categoría – <span id="nombreCategoria"></span>
        </h1>

        <!-- INFORMACIÓN DEL ENTRENADOR -->
        <h2 class="text-lg sm:text-xl font-semibold text-gray-700">Entrenador</h2>
        <p class="text-gray-600"><strong>Nombre:</strong> <span id="entrenadorNombre"></span></p>
        <p class="text-gray-600 mb-6"><strong>Correo:</strong> <span id="entrenadorCorreo"></span></p>

        <!-- =====================================
             ESTADÍSTICAS DE CATEGORÍA
        ====================================== -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-10">

            <div class="card-stat border-l-8 border-green-600 bg-green-100">
                <p class="stat-title">Activos</p>
                <p id="activos" class="stat-number text-green-700">0</p>
            </div>

            <div class="card-stat border-l-8 border-red-600 bg-red-100">
                <p class="stat-title">Inactivos</p>
                <p id="inactivos" class="stat-number text-red-700">0</p>
            </div>

            <div class="card-stat border-l-8 border-blue-600 bg-blue-100">
                <p class="stat-title">Edad Prom.</p>
                <p id="edadPromedio" class="stat-number text-blue-700">0</p>
            </div>

            <div class="card-stat border-l-8 border-yellow-500 bg-yellow-100">
                <p class="stat-title">Asistencia Prom.</p>
                <p id="asistenciaPromedio" class="stat-number text-yellow-600">0%</p>
            </div>

        </div>

        <!-- =====================================
             TABLA DE JUGADORES
        ====================================== -->
        <div class="overflow-x-auto">
            <table class="table w-full min-w-[700px]">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>RUT</th>
                        <th>Edad</th>
                        <th>Estado</th>
                        <th>Asistencia</th>
                    </tr>
                </thead>
                <tbody id="tablaJugadores"></tbody>
            </table>
        </div>

    </div>

    <!-- MARCA DE AGUA -->
    <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-0 pointer-events-none">
        <h2 class="text-6xl md:text-7xl font-extrabold text-green-600 opacity-10 select-none text-center">
            Escuela de Fútbol
        </h2>
    </div>

</main>

<!-- =====================================
         SCRIPT DE LÓGICA
======================================= -->
<script>
// =====================================
// CARGAR INFORMACIÓN
// =====================================
document.addEventListener("DOMContentLoaded", async () => {

    const categoriaId = localStorage.getItem("categoria");
    const entrenadorNombre = localStorage.getItem("nombreEntrenador");
    const entrenadorCorreo = localStorage.getItem("correoEntrenador");

    document.getElementById("entrenadorNombre").textContent = entrenadorNombre;
    document.getElementById("entrenadorCorreo").textContent = entrenadorCorreo;

    try {

        // 1️⃣ Obtener categoría
        const respCat = await fetch(`${BASE_URL}/api/categorias/${categoriaId}`);
        const categoria = await respCat.json();
        document.getElementById("nombreCategoria").textContent = categoria.nombre;

        // 2️⃣ Obtener jugadores
        const respJug = await fetch(`${BASE_URL}/api/jugadores/categoria/${categoriaId}`);
        const jugadores = await respJug.json();

        const tabla = document.getElementById("tablaJugadores");

        if (!Array.isArray(jugadores) || jugadores.length === 0) {
            tabla.innerHTML = `
                <tr>
                    <td colspan="5" class="p-4 text-center text-gray-500">
                        No hay jugadores registrados
                    </td>
                </tr>`;
            return;
        }

        // ==========================
        // ESTADÍSTICAS
        // ==========================
        const activos = jugadores.filter(j => j.estado === "activo").length;
        const inactivos = jugadores.filter(j => j.estado === "inactivo").length;

        const edades = jugadores.map(j =>
            new Date().getFullYear() - new Date(j.fechaNacimiento).getFullYear()
        );

        const edadProm = (edades.reduce((a, b) => a + b, 0) / edades.length).toFixed(1);

        document.getElementById("activos").textContent = activos;
        document.getElementById("inactivos").textContent = inactivos;
        document.getElementById("edadPromedio").textContent = edadProm;

        // ==========================
        // ASISTENCIA PROMEDIO
        // ==========================
        const eventos = await fetch(`${BASE_URL}/api/evento/categoria/${categoriaId}`)
            .then(r => r.json());

        let totalAsistencias = 0;
        let totalPosibles = 0;

        const mapa = {};
        jugadores.forEach(j => mapa[j._id] = { asistio: 0, total: 0 });

        eventos.forEach(e => {
            if (!e.asistencia) return;
            e.asistencia.forEach(reg => {
                mapa[reg.jugador].total++;
                totalPosibles++;
                if (reg.presente) {
                    mapa[reg.jugador].asistio++;
                    totalAsistencias++;
                }
            });
        });

        const asistenciaProm = totalPosibles > 0
            ? Math.round((totalAsistencias / totalPosibles) * 100)
            : 0;

        document.getElementById("asistenciaPromedio").textContent = asistenciaProm + "%";

        // ==========================
        // TABLA DE JUGADORES
        // ==========================
        tabla.innerHTML = "";

        jugadores.forEach(j => {
            const stats = mapa[j._id];
            const porcentaje = stats.total > 0
                ? Math.round((stats.asistio / stats.total) * 100)
                : 0;

            tabla.innerHTML += `
                <tr class="border-b">
                    <td class="p-2">${j.nombre}</td>
                    <td class="p-2">${j.rut}</td>
                    <td class="p-2">${new Date().getFullYear() - new Date(j.fechaNacimiento).getFullYear()}</td>
                    <td class="p-2">
                        <span class="px-2 py-1 rounded text-white text-xs
                            ${j.estado === "activo" ? "bg-green-600" : "bg-red-600"}">
                            ${j.estado}
                        </span>
                    </td>
                    <td class="p-2 font-semibold">${porcentaje}%</td>
                </tr>
            `;
        });

    } catch (error) {
        console.error("Error cargando datos:", error);
    }

});
</script>

</body>
</html>
