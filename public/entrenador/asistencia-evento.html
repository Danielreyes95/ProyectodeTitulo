<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Asistencia y Rendimiento - Entrenador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CSS Global -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
</head>

<body class="bg-gray-100">

<!-- VALIDACI√ìN -->
<script>
if (!localStorage.getItem("token") || localStorage.getItem("rol") !== "entrenador") {
    window.location.href = "../index.html";
}
</script>

<!-- SIDEBAR AUTOM√ÅTICO -->
<div id="sidebar-container"></div>
<script src="../js/loadSidebar.js"></script>

<!-- =========================================
     CONTENIDO
========================================= -->
<main class="p-4 sm:p-8 md:ml-60 max-w-6xl mx-auto">

    <!-- VOLVER -->
    <button onclick="history.back()"
        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded shadow mb-4">
        ‚Üê Volver
    </button>

    <!-- T√çTULO -->
    <div class="flex items-center gap-4 mb-6">
        <h1 id="titulo" class="text-2xl sm:text-3xl font-bold text-green-700">Evento</h1>

        <span id="badgeCerrado"
              class="hidden px-3 py-1 bg-red-600 text-white rounded text-sm font-semibold">
            EVENTO CERRADO
        </span>
    </div>

    <!-- INFORMACI√ìN DEL EVENTO -->
    <div class="bg-white p-5 rounded-xl shadow mb-6 border-l-8 border-green-600">
        <p id="infoFecha" class="text-gray-700"></p>
        <p id="infoTipo" class="text-gray-700"></p>
        <p id="infoCategoria" class="text-gray-700"></p>
    </div>

    <!-- LISTA JUGADORES -->
    <div class="bg-white p-5 rounded-xl shadow mb-6">
        <h2 class="text-xl font-bold text-green-700 mb-4">Jugadores</h2>

        <div id="contenedorJugadores" class="grid gap-6 md:grid-cols-2"></div>
    </div>

    <!-- BOTONES FINAL -->
    <div class="flex flex-col sm:flex-row justify-between gap-4 mt-6">

        <button id="btnCerrarEvento"
            class="hidden bg-red-700 hover:bg-red-800 text-white px-6 py-3 rounded shadow">
            Cerrar evento
        </button>

        <button id="btnGuardar"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded shadow">
            Guardar asistencia
        </button>

    </div>

</main>

<script src="../js/config.js"></script>

<script>
// =====================================================
// VARIABLES
// =====================================================
const idEvento = localStorage.getItem("eventoSeleccionado");
let jugadoresBase = [];
let eventoCerrado = false;

// =====================================================
// CARGAR DETALLE DEL EVENTO
// =====================================================
async function cargarDetalle() {
    const res = await fetch(`${BASE_URL}/api/evento/${idEvento}`);
    const data = await res.json();

    if (!data || !data.evento) {
        alert("Error al cargar el evento.");
        return;
    }

    const e = data.evento;
    eventoCerrado = e.cerrado;

    // üü¢ CAMPOS CORREGIDOS
    const fecha = new Date(e.fechaEvento).toLocaleDateString("es-CL");

    document.getElementById("titulo").innerText = `Evento del ${fecha}`;
    document.getElementById("infoFecha").innerText = `Fecha: ${fecha}`;
    document.getElementById("infoTipo").innerText = `Tipo: ${e.tipoEvento}`;
    document.getElementById("infoCategoria").innerText = `Categor√≠a: ${e.categoria.nombre}`;

    const cont = document.getElementById("contenedorJugadores");
    cont.innerHTML = "";

    // Armado base
    jugadoresBase = data.asistencia.map(r => ({
        jugadorId: r.jugador._id,
        nombre: r.jugador.nombre,
        rut: r.jugador.rut,
        ...r
    }));

    // Render
    jugadoresBase.forEach(j => {
        const card = document.createElement("div");
        card.className = "bg-gray-50 p-4 rounded-xl shadow border";

        card.innerHTML = `
            <h3 class="font-semibold text-lg">${j.nombre}</h3>
            <p class="text-gray-600 text-sm mb-3">${j.rut}</p>

            <!-- Asistencia -->
            <label class="flex items-center gap-2 mb-3">
                <input type="checkbox" class="chk-presente" data-id="${j.jugadorId}" 
                    ${j.presente ? "checked" : ""}>
                <span>Asisti√≥</span>
            </label>

            <!-- Motivo inasistencia -->
            <label class="block text-sm font-medium mb-1">Motivo inasistencia</label>
            <input type="text" class="input input-motivo mb-3 w-full"
                data-id="${j.jugadorId}" value="${j.motivoInasistencia ?? ""}">

            <!-- Observaci√≥n -->
            <label class="block text-sm font-medium mb-1">Observaci√≥n</label>
            <textarea class="input input-obs mb-3 w-full" rows="2"
                data-id="${j.jugadorId}">${j.observacion ?? ""}</textarea>

            <!-- Estad√≠sticas -->
            <div class="grid grid-cols-2 gap-2 mb-4 text-sm">
                ${inputNum("Goles", "goles", j)}
                ${inputNum("Asist. Gol", "asistenciasGol", j)}
                ${inputNum("Pases clave", "pasesClave", j)}
                ${inputNum("Recuperaciones", "recuperaciones", j)}
                ${inputNum("Tiros al arco", "tirosArco", j)}
                ${inputNum("Faltas cometidas", "faltasCometidas", j)}
                ${inputNum("Faltas recibidas", "faltasRecibidas", j)}
            </div>

            <!-- Tarjetas -->
            <div class="flex items-center gap-4 mb-4 text-sm">
                <label class="flex items-center gap-1">
                    <input type="checkbox" class="chk-amarilla" data-id="${j.jugadorId}"
                        ${j.amarilla ? "checked" : ""}> Amarilla
                </label>

                <label class="flex items-center gap-1">
                    <input type="checkbox" class="chk-roja" data-id="${j.jugadorId}"
                        ${j.roja ? "checked" : ""}> Roja
                </label>
            </div>

            <label class="text-sm font-medium">Rendimiento (1‚Äì10)</label>
            <input type="number" min="1" max="10"
                class="input input-rendimiento mt-1 w-24"
                data-id="${j.jugadorId}"
                value="${j.rendimiento ?? ""}">
        `;

        cont.appendChild(card);
    });

    actualizarMotivos();
    if (eventoCerrado) bloquearEvento();
}

function inputNum(titulo, campo, j) {
    return `
        <div>
            <label class="block text-xs font-medium">${titulo}</label>
            <input type="number" min="0" class="input w-full input-${campo}"
                data-id="${j.jugadorId}" value="${j[campo] ?? 0}">
        </div>
    `;
}

// =====================================================
// MOTIVOS INASISTENCIA: AUTO OCULTAR SI ASISTI√ì
// =====================================================
function actualizarMotivos() {
    document.querySelectorAll(".chk-presente").forEach(chk => {
        const id = chk.dataset.id;
        const motivo = document.querySelector(`.input-motivo[data-id='${id}']`);

        const actualizar = () => {
            const asistio = chk.checked;
            motivo.disabled = asistio;
            motivo.classList.toggle("opacity-50", asistio);
            if (asistio) motivo.value = "";
        };

        actualizar();
        chk.addEventListener("change", actualizar);
    });
}

// =====================================================
// BLOQUEAR EVENTO
// =====================================================
function bloquearEvento() {
    document.getElementById("badgeCerrado").classList.remove("hidden");
    document.getElementById("btnGuardar").classList.add("hidden");
    document.getElementById("btnCerrarEvento").classList.add("hidden");

    document.querySelectorAll("input, textarea").forEach(e => {
        e.disabled = true;
        e.classList.add("opacity-60");
    });
}

// =====================================================
// GUARDAR ASISTENCIA
// =====================================================
async function guardarAsistencia() {
    const datos = jugadoresBase.map(j => ({
        jugador: j.jugadorId,
        presente: sel(".chk-presente", j).checked,
        observacion: sel(".input-obs", j).value,
        motivoInasistencia: sel(".input-motivo", j).value,
        goles: num(".input-goles", j),
        asistenciasGol: num(".input-asistenciasGol", j),
        pasesClave: num(".input-pasesClave", j),
        recuperaciones: num(".input-recuperaciones", j),
        tirosArco: num(".input-tirosArco", j),
        faltasCometidas: num(".input-faltasCometidas", j),
        faltasRecibidas: num(".input-faltasRecibidas", j),
        amarilla: sel(".chk-amarilla", j).checked,
        roja: sel(".chk-roja", j).checked,
        rendimiento: Number(sel(".input-rendimiento", j).value) || null
    }));

    const res = await fetch(`${BASE_URL}/api/evento/${idEvento}/asistencia`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ asistencia: datos })
    });

    alert(res.ok ? "Asistencia guardada correctamente." : "Error al guardar.");
}

function sel(selector, j) {
    return document.querySelector(`${selector}[data-id='${j.jugadorId}']`);
}

function num(selector, j) {
    return Number(sel(selector, j).value) || 0;
}

// =====================================================
// CERRAR EVENTO
// =====================================================
async function cerrarEvento() {
    if (!confirm("¬øDeseas cerrar este evento? Ya no podr√°s editarlo.")) return;

    const res = await fetch(`${BASE_URL}/api/evento/${idEvento}/cerrar`, { method: "PUT" });

    if (res.ok) {
        alert("Evento cerrado correctamente.");
        bloquearEvento();
    } else {
        alert("Error al cerrar el evento.");
    }
}

// =====================================================
// EVENTOS BOTONES
// =====================================================
document.getElementById("btnGuardar").addEventListener("click", guardarAsistencia);
document.getElementById("btnCerrarEvento").addEventListener("click", cerrarEvento);

cargarDetalle().then(() => {
    if (!eventoCerrado) {
        document.getElementById("btnCerrarEvento").classList.remove("hidden");
    }
});
</script>

</body>
</html>
