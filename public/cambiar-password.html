<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Cambiar Contraseña</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Estilos globales -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
</head>

<body class="bg-gray-100">

<script>
if (!localStorage.getItem("token")) {
    window.location.href = "../index.html";
}
</script>

<!-- ==========================
       MENÚ MÓVIL
========================== -->
<button id="btnMenu"
    class="md:hidden fixed top-4 left-4 bg-green-700 text-white p-2 rounded shadow z-50">
    ☰
</button>

<!-- ==========================
       SIDEBAR DINÁMICO
========================== -->
<div id="sidebarContainer"></div>
<script src="../js/loadSidebar.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnMenu");
    btn.addEventListener("click", () => {
        const sidebar = document.querySelector("#sidebar");
        if (sidebar) sidebar.classList.toggle("active");
    });
});
</script>

<!-- ==========================
       CONTENIDO
========================== -->
<main class="flex-1 p-6 md:p-10 md:ml-60 max-w-xl mx-auto">

    <h1 class="text-3xl font-bold text-green-700 mb-8 text-center">
        Cambiar Contraseña
    </h1>

    <div class="card">
        
        <label class="font-semibold">Contraseña actual</label>
        <input id="passwordActual" type="password" class="input mb-4" placeholder="•••••••">

        <label class="font-semibold">Nueva contraseña</label>
        <input id="passwordNueva" type="password" class="input mb-4" placeholder="•••••••">

        <label class="font-semibold">Repetir nueva contraseña</label>
        <input id="passwordRepetir" type="password" class="input mb-4" placeholder="•••••••">

        <p id="msg" class="hidden alert mt-3"></p>

        <button onclick="cambiarPassword()" class="btn btn-primary w-full mt-4">
            Guardar cambios
        </button>
    </div>

</main>

<script src="../js/config.js"></script>

<script>
async function cambiarPassword() {

    const actual = passwordActual.value.trim();
    const nueva = passwordNueva.value.trim();
    const repetir = passwordRepetir.value.trim();
    const msg = document.getElementById("msg");

    msg.classList.add("hidden");

    if (!actual || !nueva || !repetir) {
        mostrarMensaje("Debe completar todos los campos.", "error");
        return;
    }

    if (nueva.length < 6) {
        mostrarMensaje("La nueva contraseña debe tener al menos 6 caracteres.", "error");
        return;
    }

    if (nueva !== repetir) {
        mostrarMensaje("Las contraseñas no coinciden.", "error");
        return;
    }

    try {
        const res = await fetch(`${BASE_URL}/api/auth/cambiar-password`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + localStorage.getItem("token")
            },
            body: JSON.stringify({ actual, nueva })
        });

        const data = await res.json();

        if (!res.ok) {
            mostrarMensaje(data.error || "Error al cambiar la contraseña.", "error");
            return;
        }

        mostrarMensaje("Contraseña actualizada correctamente.", "success");
        
        passwordActual.value = "";
        passwordNueva.value = "";
        passwordRepetir.value = "";

    } catch (error) {
        mostrarMensaje("Error del servidor.", "error");
    }
}

function mostrarMensaje(texto, tipo) {
    const msg = document.getElementById("msg");
    msg.textContent = texto;
    msg.classList.remove("hidden");

    msg.classList.remove("alert-error", "alert-success");

    if (tipo === "error") msg.classList.add("alert-error");
    else msg.classList.add("alert-success");
}
</script>

</body>
</html>
