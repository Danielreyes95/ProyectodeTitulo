<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Jugadores - Director</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Estilos globales -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">

    <style>
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 450px;
            box-shadow: 0px 6px 16px rgba(0,0,0,0.12);
        }

        .input {
            width: 100%;
            border: 1px solid #e5e7eb;
            padding: 10px;
            border-radius: 8px;
        }
    </style>
</head>

<body>

<!-- ============================
        VALIDACIÓN
============================ -->
<script>
if (!localStorage.getItem("token") || localStorage.getItem("rol") !== "director") {
    window.location.href = "../index.html";
}
</script>

<!-- ============================
        MENÚ MÓVIL
============================ -->
<button id="btnMenu"
    class="md:hidden fixed top-4 left-4 bg-green-700 text-white p-2 rounded shadow z-50">
    ☰
</button>

<!-- ============================
        SIDEBAR DINÁMICO
============================ -->
<div id="sidebarContainer"></div>
<script src="../js/loadSidebar.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnMenu");
    btn.addEventListener("click", () => {
        const sidebar = document.querySelector("#sidebar");
        if (sidebar) sidebar.classList.toggle("active");
    });
});
</script>

<!-- ============================
        CONTENIDO PRINCIPAL
============================ -->
<main class="flex-1 p-6 md:p-10 md:ml-60">

    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-green-700">Lista de Jugadores</h1>

        <button onclick="mostrarModalCrearJugador()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded shadow">
            + Agregar Jugador
        </button>
    </div>

    <!-- Buscador -->
    <div class="mb-6">
        <input 
            id="buscador"
            oninput="filtrarJugadores()"
            placeholder="Buscar por nombre o RUT..."
            class="input w-full"
        >
    </div>

    <!-- Tabla -->
    <div class="bg-white shadow rounded-lg p-4 overflow-x-auto">
        <table class="w-full min-w-[800px] table-auto">
            <thead>
                <tr class="border-b bg-gray-200">
                    <th class="p-3 text-left">Nombre</th>
                    <th class="p-3 text-left">RUT</th>
                    <th class="p-3 text-left">Edad</th>
                    <th class="p-3 text-left">Categoría</th>
                    <th class="p-3 text-left">Apoderado</th>
                    <th class="p-3 text-left">Estado</th>
                    <th class="p-3 text-center">Acciones</th>
                </tr>
            </thead>
            <tbody id="tbodyJugadores"></tbody>
        </table>
    </div>

</main>

<!-- ============================
        MODAL CREAR JUGADOR
============================ -->
<div id="modalCrearJugador" class="modal-overlay hidden">

    <div class="modal-box">

        <h2 class="text-xl font-bold text-green-700 mb-4">Registrar Jugador</h2>

        <h3 class="font-semibold mb-2">Datos del Apoderado</h3>
        <input id="rutApoderado" class="input mb-2" placeholder="RUT Apoderado">
        <input id="nombreApoderado" class="input mb-2" placeholder="Nombre Apoderado">
        <input id="telefonoApoderado" class="input mb-2" placeholder="Teléfono">
        <input id="correoApoderado" class="input mb-4" placeholder="Correo">

        <h3 class="font-semibold mb-2">Datos del Jugador</h3>
        <input id="rutJugador" class="input mb-2" placeholder="RUT Jugador">
        <input id="nombreJugador" class="input mb-2" placeholder="Nombre Jugador">
        <input id="fechaNacimientoJugador" type="date" class="input mb-4">

        <button onclick="registrarJugador()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full">
            Guardar
        </button>

        <button onclick="ocultarModalCrearJugador()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded w-full mt-2">
            Cancelar
        </button>

    </div>
</div>

<!-- CONFIG -->
<script src="../js/config.js"></script>

<script>
/* ==========================================================
        TU JS ORIGINAL (NO MODIFICADO)
========================================================== */

function calcularEdad(fecha) {
    const n = new Date(fecha);
    const h = new Date();
    let edad = h.getFullYear() - n.getFullYear();
    const m = h.getMonth() - n.getMonth();
    if (m < 0 || (m === 0 && h.getDate() < n.getDate())) edad--;
    return edad;
}

let jugadoresOriginal = [];

/* ===========================
   Cargar jugadores
=========================== */
async function cargarJugadores() {
    try {
        const res = await fetch(`${BASE_URL}/api/jugadores/listar`);
        const jugadores = await res.json();
        jugadoresOriginal = jugadores;

        const tbody = document.getElementById("tbodyJugadores");
        tbody.innerHTML = "";

        jugadores.forEach(j => {
            tbody.innerHTML += `
                <tr class="border-b">
                    <td class="p-3 col-nombre">${j.nombre}</td>
                    <td class="p-3 col-rut">${j.rut}</td>
                    <td class="p-3">${calcularEdad(j.fechaNacimiento)}</td>
                    <td class="p-3">${j.categoria?.nombre ?? "Sin categoría"}</td>
                    <td class="p-3">${j.apoderado?.nombre ?? "Sin apoderado"}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-white
                            ${j.estado === "activo" ? "bg-green-600" : "bg-red-600"}">
                            ${j.estado}
                        </span>
                    </td>
                    <td class="p-3 text-center">
                        <button
                            onclick="cambiarEstado('${j._id}', '${j.estado}')"
                            class="text-white px-3 py-1 rounded
                                ${j.estado === 'activo' ? 'bg-red-600' : 'bg-green-600'}">
                            ${j.estado === 'activo' ? 'Desactivar' : 'Activar'}
                        </button>
                    </td>
                </tr>
            `;
        });

    } catch (error) {
        alert("Error al cargar jugadores");
    }
}

/* ===========================
   Cambiar estado
=========================== */
async function cambiarEstado(id, estadoActual) {
    if (!confirm("Confirmar acción")) return;

    await fetch(`${BASE_URL}/api/jugadores/cambiar-estado/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" }
    });

    cargarJugadores();
}

/* ===========================
   Registrar jugador
=========================== */
async function registrarJugador() {
    const data = {
        rutApoderado: rutApoderado.value,
        nombreApoderado: nombreApoderado.value,
        telefono: telefonoApoderado.value,
        correo: correoApoderado.value,
        rutJugador: rutJugador.value,
        nombreJugador: nombreJugador.value,
        fechaNacimiento: fechaNacimientoJugador.value
    };

    const res = await fetch(`${BASE_URL}/api/jugadores/registrar`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });

    const info = await res.json();
    alert("Contraseña temporal apoderado: " + info.passwordTemporalApoderado);

    ocultarModalCrearJugador();
    cargarJugadores();
}

/* ===========================
   Modal
=========================== */
function mostrarModalCrearJugador() {
    modalCrearJugador.classList.remove("hidden");
}

function ocultarModalCrearJugador() {
    modalCrearJugador.classList.add("hidden");
}

/* ===========================
   Buscador
=========================== */
function filtrarJugadores() {
    const texto = buscador.value.toLowerCase();
    const filas = document.querySelectorAll("#tbodyJugadores tr");

    filas.forEach(fila => {
        const nombre = fila.querySelector(".col-nombre").textContent.toLowerCase();
        const rut = fila.querySelector(".col-rut").textContent.toLowerCase();
        fila.classList.toggle("hidden", !nombre.includes(texto) && !rut.includes(texto));
    });
}

cargarJugadores();
</script>

</body>
</html>
