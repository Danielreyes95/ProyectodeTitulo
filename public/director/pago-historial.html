<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Historial de Pagos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Estilos globales -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">

</head>

<body class="bg-gray-100">

<!-- ============================
     MENÚ MÓVIL
============================ -->
<button id="btnMenu"
    class="md:hidden fixed top-4 left-4 bg-green-700 text-white p-2 rounded z-50 shadow">
    ☰
</button>

<!-- ============================
     SIDEBAR DINÁMICO
============================ -->
<div id="sidebarContainer"></div>
<script src="../js/loadSidebar.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnMenu");
    btn.addEventListener("click", () => {
        const sidebar = document.querySelector("#sidebar");
        if (sidebar) sidebar.classList.toggle("active");
    });
});
</script>

<!-- ============================
     CONTENIDO
============================ -->
<main class="flex-1 p-6 md:p-10 md:ml-60">

    <!-- Botón volver -->
    <button onclick="window.location.href='./pagos.html'"
        class="bg-gray-300 hover:bg-gray-400 text-black px-4 py-2 rounded shadow mb-6">
        ← Volver
    </button>

    <h1 id="tituloJugador"
        class="text-3xl font-bold text-green-700 mb-6">
        Historial de Pagos
    </h1>

    <!-- Información del jugador -->
    <div class="bg-white shadow p-5 rounded-lg mb-8">
        <p id="infoNombre" class="font-semibold"></p>
        <p id="infoRut"></p>
        <p id="infoCategoria"></p>
    </div>

    <!-- TABLA -->
    <div class="bg-white shadow p-4 rounded-lg overflow-x-auto">
        <table class="w-full min-w-[700px] table-auto">
            <thead>
                <tr class="border-b bg-gray-200">
                    <th class="p-2 text-left">Fecha de Pago</th>
                    <th class="p-2 text-left">Mes</th>
                    <th class="p-2 text-left">Monto</th>
                    <th class="p-2 text-left">Método</th>
                    <th class="p-2 text-left">Observación</th>
                </tr>
            </thead>

            <tbody id="tbodyHistorial"></tbody>
        </table>

        <p id="mensajeVacio"
            class="text-gray-600 text-center mt-4 hidden">
            Este jugador no tiene pagos registrados.
        </p>
    </div>

</main>


<script src="../js/config.js"></script>

<script>

const idJugador = localStorage.getItem("pagoJugador");

// Validación
if (!idJugador) {
    alert("Jugador no seleccionado");
    window.location.href = "./pagos.html";
}

/* ================================
   CLP
================================ */
function formatoCLP(monto) {
    return monto.toLocaleString("es-CL");
}

/* ================================
   Datos del Jugador
================================ */
async function cargarJugador() {
    const res = await fetch(`${BASE_URL}/api/jugadores/${idJugador}`);
    const j = await res.json();

    document.getElementById("tituloJugador").innerText =
        `Historial de Pago de ${j.nombre}`;

    document.getElementById("infoNombre").innerText =
        `Nombre: ${j.nombre}`;

    document.getElementById("infoRut").innerText =
        `RUT: ${j.rut}`;

    document.getElementById("infoCategoria").innerText =
        `Categoría: ${j.categoria?.nombre ?? "-"}`;
}

/* ================================
   Historial
================================ */
async function cargarHistorial() {

    const res = await fetch(`${BASE_URL}/api/pagos/historial/${idJugador}`);
    const data = await res.json();

    const tbody = document.getElementById("tbodyHistorial");
    const mensajeVacio = document.getElementById("mensajeVacio");

    tbody.innerHTML = "";

    if (data.length === 0) {
        mensajeVacio.classList.remove("hidden");
        return;
    }

    mensajeVacio.classList.add("hidden");

    data.forEach(p => {
        tbody.innerHTML += `
            <tr class="border-b">
                <td class="p-2">${p.fechaPago ? new Date(p.fechaPago).toLocaleDateString("es-CL") : "-"}</td>
                <td class="p-2">${p.mes}</td>
                <td class="p-2">$${formatoCLP(p.monto)}</td>
                <td class="p-2">${p.metodoPago}</td>
                <td class="p-2">${p.observacion ?? "-"}</td>
            </tr>
        `;
    });
}

cargarJugador();
cargarHistorial();

</script>

</body>
</html>
