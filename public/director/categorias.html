<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Categorías - Director</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

<script>
if (!localStorage.getItem("token") || localStorage.getItem("rol") !== "director") {
    window.location.href = "../index.html";
}
</script>

<div class="flex">

    <!-- SIDEBAR -->
    <aside class="w-60 bg-green-700 text-white min-h-screen p-4 flex flex-col gap-4">
        <h2 class="text-xl font-bold mb-5 text-center">Director</h2>

        <a href="./director.html">Inicio</a>
        <a href="./jugadores.html">Jugadores</a>
        <a href="./entrenadores.html">Entrenadores</a>
        <a href="./categorias.html" class="font-bold underline">Categorías</a>
        <a href="./pagos.html">Pagos</a>
        <a href="./avisos.html">Avisos</a>
        <a href="./reportes.html">Reportes</a>

        <button onclick="logout()" class="bg-red-600 p-2 mt-auto rounded">
            Cerrar sesión
        </button>
    </aside>

    <!-- ================================
         CONTENIDO PRINCIPAL
    ================================ -->
    <main class="flex-1 p-8 flex gap-6">

        <!-- LISTA DE CATEGORÍAS -->
        <div class="w-1/4 bg-white shadow rounded-lg p-4">

            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">Categorías</h2>

                <!-- ✔ BOTÓN CREAR -->
                <button onclick="abrirModalCategoria(null)"
                    class="bg-blue-600 text-white px-2 py-1 rounded text-sm hover:bg-blue-800">
                    + Crear
                </button>
            </div>

            <ul id="listaCategorias" class="space-y-2"></ul>
        </div>
        <!-- PANEL DERECHO -->
        <div class="flex-1 bg-white shadow rounded-lg p-6">

            <h2 id="tituloCategoria" class="text-2xl font-bold mb-4 text-green-700">
                Selecciona una categoría
            </h2>

            <!-- BOTONES EDITAR / ELIMINAR -->
            <div id="accionesCategoria" class="flex gap-3 mb-6 hidden">
                <button onclick="abrirModalCategoria(categoriaSeleccionada)"
                    class="bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700">
                    Editar
                </button>

                <button onclick="abrirModalEliminar()"
                    class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                    Eliminar
                </button>
            </div>

            <!-- ENTRENADOR ASIGNADO -->
            <div id="bloqueEntrenador" class="hidden mb-6">
                <h3 class="text-xl font-semibold mb-2">Entrenador</h3>
                <p id="nombreEntrenador"></p>
                <p id="correoEntrenador"></p>
            </div>

            <!-- ESTADÍSTICAS -->
            <div id="bloqueEstadisticas" class="hidden mb-6">
                <h3 class="text-xl font-semibold mb-3">Estadísticas</h3>

                <div class="grid grid-cols-4 gap-4">
                    <div class="p-4 bg-green-100 rounded text-center">
                        <p>Activos</p>
                        <p id="statActivos" class="text-2xl font-bold">0</p>
                    </div>

                    <div class="p-4 bg-red-100 rounded text-center">
                        <p>Inactivos</p>
                        <p id="statInactivos" class="text-2xl font-bold">0</p>
                    </div>

                    <div class="p-4 bg-blue-100 rounded text-center">
                        <p>Edad Prom.</p>
                        <p id="statEdadPromedio" class="text-2xl font-bold">0</p>
                    </div>

                    <div class="p-4 bg-yellow-100 rounded text-center">
                        <p>Asistencia Prom.</p>
                        <p id="statAsistenciaProm" class="text-2xl font-bold">0%</p>
                    </div>
                </div>
            </div>

            <!-- TABLA DE JUGADORES -->
            <div id="bloqueJugadores" class="hidden">
                <h3 class="text-xl font-semibold mb-3">Jugadores</h3>

                <table class="w-full table-auto">
                    <thead>
                        <tr class="border-b bg-gray-200">
                            <th class="p-2">Nombre</th>
                            <th class="p-2">RUT</th>
                            <th class="p-2">Edad</th>
                            <th class="p-2">Estado</th>
                            <th class="p-2">Asistencia</th>
                            <th class="p-2">Detalle</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyJugadores"></tbody>
                </table>
            </div>

        </div>
    </main>
</div>
<!-- ===============================
     MODAL CREAR / EDITAR CATEGORÍA
================================ -->
<div id="modalCategoria" class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">

        <h2 id="tituloModalCategoria" class="text-xl font-bold text-green-700 mb-4">
            Crear Categoría
        </h2>

        <input type="hidden" id="categoriaId" />

        <!-- Nombre -->
        <div class="mb-3">
            <label class="font-semibold">Nombre</label>
            <input id="categoriaNombre" type="text" class="border p-2 rounded w-full" placeholder="Ej: Sub-10">
        </div>

        <!-- Edad mínima -->
        <div class="mb-3">
            <label class="font-semibold">Edad mínima</label>
            <input id="categoriaEdadMin" type="number" min="3" max="20" class="border p-2 rounded w-full" placeholder="Ej: 8">
        </div>

        <!-- Edad máxima -->
        <div class="mb-3">
            <label class="font-semibold">Edad máxima</label>
            <input id="categoriaEdadMax" type="number" min="3" max="20" class="border p-2 rounded w-full" placeholder="Ej: 10">
        </div>

        <!-- Entrenador -->
        <div class="mb-3">
            <label class="font-semibold">Entrenador</label>

            <select id="categoriaEntrenador" class="border p-2 rounded w-full">
                <option value="">Seleccione un entrenador</option>
            </select>
        </div>

        <div class="flex justify-end gap-2 mt-4">
            <button onclick="cerrarModalCategoria()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">
                Cancelar
            </button>

            <button onclick="guardarCategoria()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                Guardar
            </button>
        </div>
    </div>
</div>

<!-- ===============================
     MODAL ELIMINAR CATEGORÍA
================================ -->
<div id="modalEliminar" class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-80">

        <h2 class="text-xl font-bold text-red-700 mb-4">Eliminar Categoría</h2>

        <p>¿Estás seguro de eliminar esta categoría?</p>
        <p class="text-sm text-gray-600 mt-2">Esta acción no se puede deshacer.</p>

        <div class="flex justify-end gap-2 mt-4">
            <button onclick="cerrarModalEliminar()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">
                Cancelar
            </button>

            <button onclick="confirmarEliminarCategoria()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                Eliminar
            </button>
        </div>
    </div>
</div>

<script>
function logout() {
    localStorage.clear();
    window.location.href = "../index.html";
}

let categoriaSeleccionada = null;

/* =====================================================
   CARGAR CATEGORÍAS + CONTAR JUGADORES
===================================================== */
async function cargarCategorias() {

    const catRes = await fetch("http://localhost:3000/api/categorias");
    const categorias = await catRes.json();

    const jugadoresRes = await fetch("http://localhost:3000/api/jugadores/listar");
    const jugadores = await jugadoresRes.json();

    const lista = document.getElementById("listaCategorias");
    lista.innerHTML = "";

    categorias.forEach(c => {
        const cantidad = jugadores.filter(j => j.categoria?._id === c._id).length;

        lista.innerHTML += `
            <li>
                <button 
                    onclick="verCategoria('${c._id}')"
                    class="w-full text-left p-2 bg-gray-100 hover:bg-green-100 rounded categoriaBtn"
                    data-id="${c._id}">
                    ${c.nombre} · <span class="text-sm text-gray-600">${cantidad} jugadores</span>
                </button>
            </li>
        `;
    });
}

/* =====================================================
   VER CATEGORÍA SELECCIONADA
===================================================== */
async function verCategoria(idCategoria) {

    categoriaSeleccionada = idCategoria;

    // Resaltar seleccionada
    document.querySelectorAll(".categoriaBtn").forEach(btn => {
        btn.classList.remove("bg-green-200");
        if (btn.dataset.id === idCategoria) {
            btn.classList.add("bg-green-200");
        }
    });

    const categoriaRes = await fetch(`http://localhost:3000/api/categorias/${idCategoria}`);
    const categoria = await categoriaRes.json();

    document.getElementById("tituloCategoria").innerText = categoria.nombre;
    document.getElementById("accionesCategoria").classList.remove("hidden");

    // ENTRENADOR
    if (categoria.entrenador) {
        document.getElementById("bloqueEntrenador").classList.remove("hidden");
        document.getElementById("nombreEntrenador").innerText = `Nombre: ${categoria.entrenador.nombre}`;
        document.getElementById("correoEntrenador").innerText = `Correo: ${categoria.entrenador.correo}`;
    } else {
        document.getElementById("bloqueEntrenador").classList.add("hidden");
    }

    // LISTAR JUGADORES
    const jugadoresRes = await fetch("http://localhost:3000/api/jugadores/listar");
    const jugadores = await jugadoresRes.json();

    const jugadoresCat = jugadores.filter(j => j.categoria?._id === idCategoria);
    const tbody = document.getElementById("tbodyJugadores");
    tbody.innerHTML = "";

    for (const j of jugadoresCat) {
        const edad = calcularEdad(j.fechaNacimiento);

        // Obtener estadísticas del jugador
        const asRes = await fetch(`http://localhost:3000/api/asistencia/jugador/${j._id}/stats`);
        const stats = await asRes.json();

        tbody.innerHTML += `
            <tr class="border-b">
                <td class="p-2">${j.nombre}</td>
                <td class="p-2">${j.rut}</td>
                <td class="p-2">${edad}</td>
                <td class="p-2">
                    <span class="px-2 py-1 rounded text-white ${j.estado === "activo" ? "bg-green-600" : "bg-red-600"}">
                        ${j.estado}
                    </span>
                </td>
                <td class="p-2 font-bold">${stats.porcentaje}%</td>
                <td class="p-2">
                    <button onclick="verDetalleAsistencia('${j._id}')"
                        class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-800">
                        +
                    </button>
                </td>
            </tr>
        `;
    }

    // ESTADÍSTICAS DE LA CATEGORÍA
    document.getElementById("bloqueEstadisticas").classList.remove("hidden");
    document.getElementById("bloqueJugadores").classList.remove("hidden");

    const asRes = await fetch(`http://localhost:3000/api/asistencia/categoria/${idCategoria}/stats`);
    const asData = await asRes.json();

    const activos = jugadoresCat.filter(j => j.estado === "activo").length;
    const inactivos = jugadoresCat.filter(j => j.estado === "inactivo").length;

    const edades = jugadoresCat.map(j => calcularEdad(j.fechaNacimiento));
    const edadPromedio = edades.length ? (edades.reduce((a, b) => a + b) / edades.length).toFixed(1) : 0;

    document.getElementById("statActivos").innerText = activos;
    document.getElementById("statInactivos").innerText = inactivos;
    document.getElementById("statEdadPromedio").innerText = edadPromedio;
    document.getElementById("statAsistenciaProm").innerText = `${asData.promedioAsistencia ?? 0}%`;
}

/* =====================================================
   VER DETALLE ASISTENCIA JUGADOR
===================================================== */
function verDetalleAsistencia(idJugador) {
    localStorage.setItem("jugadorAsistencia", idJugador);
    localStorage.setItem("categoriaAutoOpen", categoriaSeleccionada);
    window.location.href = "./asistencia-jugador.html";
}

/* =====================================================
   FUNCIONES DE APOYO
===================================================== */
function calcularEdad(fecha) {
    const n = new Date(fecha);
    const h = new Date();
    let edad = h.getFullYear() - n.getFullYear();
    const m = h.getMonth() - n.getMonth();
    if (m < 0 || (m === 0 && h.getDate() < n.getDate())) edad--;
    return edad;
}

/* =====================================================
   ABRIR MODAL CREAR/EDITAR
===================================================== */
async function abrirModalCategoria(idCat = null) {

    document.getElementById("modalCategoria").classList.remove("hidden");

    // cargar entrenadores
    await cargarEntrenadoresDisponibles();

    if (idCat === null) {
        // CREAR
        document.getElementById("tituloModalCategoria").innerText = "Crear Categoría";
        document.getElementById("categoriaId").value = "";
        document.getElementById("categoriaNombre").value = "";
        document.getElementById("categoriaEdadMin").value = "";
        document.getElementById("categoriaEdadMax").value = "";
        document.getElementById("categoriaEntrenador").value = "";
    } else {
        // EDITAR
        await cargarDatosEditar(idCat);
    }
}

function cerrarModalCategoria() {
    document.getElementById("modalCategoria").classList.add("hidden");
}

/* =====================================================
   CARGAR ENTRENADORES DISPONIBLES
===================================================== */
async function cargarEntrenadoresDisponibles() {
    const res = await fetch("http://localhost:3000/api/categorias/entrenadores/disponibles");
    const entrenadores = await res.json();

    const select = document.getElementById("categoriaEntrenador");
    select.innerHTML = `<option value="">Sin entrenador</option>`;

    entrenadores.forEach(e => {
        select.innerHTML += `
            <option value="${e._id}">${e.nombre} (${e.rut})</option>
        `;
    });
}

/* =====================================================
   CARGAR DATOS PARA EDITAR CATEGORÍA
===================================================== */
async function cargarDatosEditar(idCat) {

    const res = await fetch(`http://localhost:3000/api/categorias/${idCat}`);
    const c = await res.json();

    document.getElementById("tituloModalCategoria").innerText = "Editar Categoría";
    document.getElementById("categoriaId").value = c._id;
    document.getElementById("categoriaNombre").value = c.nombre;
    document.getElementById("categoriaEdadMin").value = c.edadMin ?? "";
    document.getElementById("categoriaEdadMax").value = c.edadMax ?? "";
    document.getElementById("categoriaEntrenador").value = c.entrenador?._id ?? "";
}

/* =====================================================
   GUARDAR (CREAR O EDITAR)
===================================================== */
async function guardarCategoria() {

    const id = document.getElementById("categoriaId").value;
    const nombre = document.getElementById("categoriaNombre").value.trim();
    const edadMin = document.getElementById("categoriaEdadMin").value;
    const edadMax = document.getElementById("categoriaEdadMax").value;
    const entrenador = document.getElementById("categoriaEntrenador").value;

    if (!nombre || !edadMin || !edadMax) {
        alert("Debe completar nombre, edad mínima y edad máxima.");
        return;
    }

    const body = { nombre, edadMin, edadMax, entrenador };

    let url = "http://localhost:3000/api/categorias/crear";
    let method = "POST";

    if (id) {
        url = `http://localhost:3000/api/categorias/${id}/editar`;
        method = "PUT";
    }

    const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    const data = await res.json();

    if (data.error) {
        alert("Error: " + data.error);
        return;
    }

    alert("Categoría guardada correctamente.");
    cerrarModalCategoria();
    cargarCategorias();
}

/* =====================================================
   ABRIR MODAL ELIMINAR
===================================================== */
function abrirModalEliminar() {
    document.getElementById("modalEliminar").classList.remove("hidden");
}

function cerrarModalEliminar() {
    document.getElementById("modalEliminar").classList.add("hidden");
}

/* =====================================================
   CONFIRMAR ELIMINAR
===================================================== */
async function confirmarEliminarCategoria() {

    if (!categoriaSeleccionada) return;

    const res = await fetch(`http://localhost:3000/api/categorias/${categoriaSeleccionada}/eliminar`, {
        method: "DELETE"
    });

    const data = await res.json();

    if (data.error) {
        alert("⚠ " + data.error);
        return;
    }

    alert("Categoría eliminada correctamente.");

    cerrarModalEliminar();

    // resetear panel
    categoriaSeleccionada = null;
    document.getElementById("tituloCategoria").innerText = "Selecciona una categoría";
    document.getElementById("accionesCategoria").classList.add("hidden");
    document.getElementById("bloqueEntrenador").classList.add("hidden");
    document.getElementById("bloqueEstadísticas").classList.add("hidden");
    document.getElementById("bloqueJugadores").classList.add("hidden");

    cargarCategorias();
}

cargarCategorias();
</script>

</body>
</html>
