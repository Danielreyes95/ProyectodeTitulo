<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos del Jugador</title>

    <!-- TAILWIND -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ESTILOS GLOBALES -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">

    <style>
        .tag {
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-gray-100">

<!-- üîê VALIDACI√ìN -->
<script>
if (!localStorage.getItem("token") || localStorage.getItem("rol") !== "apoderado") {
    window.location.href = "../index.html";
}
</script>

<!-- CONFIG -->
<script src="../js/config.js"></script>

<!-- SIDEBAR DIN√ÅMICO -->
<div id="sidebar-container"></div>
<script src="../js/loadSidebar.js"></script>

<!-- ==============================
     CONTENIDO PRINCIPAL
============================== -->
<main class="p-6 md:ml-60 transition-all max-w-4xl mx-auto">

    <!-- VOLVER -->
    <button onclick="window.location.href='./jugador.html'" 
        class="bg-gray-200 px-4 py-2 rounded mb-5 shadow hover:bg-gray-300">
        ‚Üê Volver
    </button>

    <h1 class="text-3xl font-bold text-green-700 mb-3">
        Eventos de la Categor√≠a
    </h1>

    <p class="text-gray-600 mb-6">
        Jugador: <span class="font-semibold" id="nombreJugador"></span> ‚Ä¢  
        Categor√≠a: <span class="font-semibold" id="categoriaJugador"></span>
    </p>

    <!-- CONTENEDOR EVENTOS -->
    <div id="contenedorEventos" class="grid gap-6"></div>

</main>

<!-- ==============================
     SCRIPT L√ìGICA
============================== -->
<script>
const idJugador = localStorage.getItem("idJugador");
const categoriaJugador = localStorage.getItem("categoriaJugador");
const nombreJugador = localStorage.getItem("nombreJugador");
const categoriaNombreJugador = localStorage.getItem("categoriaNombreJugador");

document.getElementById("nombreJugador").innerText = nombreJugador;
document.getElementById("categoriaJugador").innerText = categoriaNombreJugador;

/* ============================================================
   CARGAR EVENTOS  
============================================================ */
async function cargarEventos() {
    const cont = document.getElementById("contenedorEventos");
    cont.innerHTML = `<p class="text-gray-500">Cargando eventos...</p>`;

    try {
        const res = await fetch(`${BASE_URL}/api/evento/categoria/${categoriaJugador}`);
        const eventos = await res.json();

        cont.innerHTML = "";

        if (!Array.isArray(eventos) || eventos.length === 0) {
            cont.innerHTML = `<p class="text-gray-600">No hay eventos registrados.</p>`;
            return;
        }

        const hoy = new Date();

        eventos.forEach(ev => {
            const fecha = new Date(ev.fechaEvento);
            const fechaTxt = fecha.toLocaleDateString("es-CL");

            const esFuturo = fecha >= new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

            cont.innerHTML += `
                <div class="bg-white p-5 rounded-xl shadow border-l-8 
                    ${esFuturo ? "border-blue-600" : "border-gray-500"}">

                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-green-700">${ev.tipoEvento}</h2>
                        <span class="tag ${esFuturo ? "bg-blue-100 text-blue-700" : "bg-gray-300 text-gray-700"}">
                            ${esFuturo ? "Pr√≥ximo" : "Pasado"}
                        </span>
                    </div>

                    <p class="text-gray-600 mt-1">
                        Fecha: <span class="font-medium">${fechaTxt}</span>
                    </p>

                    <div class="mt-4 flex flex-wrap gap-3">

                        <!-- VER DETALLE -->
                        <button onclick="verDetalle('${ev._id}')"
                            class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700">
                            Ver detalles
                        </button>

                        <!-- CONFIRMAR ASISTENCIA -->
                        ${esFuturo ? `
                            <button onclick="confirmarAsistencia('${ev._id}')"
                                class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                                Confirmar asistencia
                            </button>
                        ` : ""}
                    </div>
                </div>
            `;
        });

    } catch (error) {
        cont.innerHTML = `<p class="text-red-600">Error al cargar eventos.</p>`;
    }
}

/* ============================================================
   VER DETALLE
============================================================ */
function verDetalle(eventoId) {
    localStorage.setItem("eventoJugadorSeleccionado", eventoId);
    window.location.href = "./detalle-evento-jugador.html";
}

/* ============================================================
   CONFIRMAR ASISTENCIA
============================================================ */
async function confirmarAsistencia(eventoId) {
    if (!confirm("¬øConfirmas tu asistencia a este evento?")) return;

    try {
        await fetch(`${BASE_URL}/api/evento/${eventoId}/asistencia/${idJugador}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                presente: true,
                observacion: "",
                motivoInasistencia: ""
            })
        });

        alert("Asistencia confirmada ‚úî");
        cargarEventos();

    } catch (error) {
        alert("Error al confirmar asistencia");
    }
}

cargarEventos();
</script>

</body>
</html>
