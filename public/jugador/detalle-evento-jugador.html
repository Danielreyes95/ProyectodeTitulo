<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Evento</title>

    <!-- TAILWIND -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CSS GLOBAL -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
</head>

<body class="bg-gray-100">

<!-- VALIDACIÓN -->
<script>
if (!localStorage.getItem("token") || localStorage.getItem("rol") !== "apoderado") {
    window.location.href = "../index.html";
}
</script>

<!-- CONFIG GLOBAL -->
<script src="../js/config.js"></script>

<!-- SIDEBAR DINÁMICO -->
<div id="sidebar-container"></div>
<script src="../js/loadSidebar.js"></script>

<!-- CONTENIDO -->
<main class="p-6 md:ml-60 transition-all">

    <!-- Botón volver -->
    <button onclick="window.location.href='./eventos-jugador.html'"
        class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded shadow mb-5">
        ← Volver
    </button>

    <h1 class="text-3xl font-bold text-green-700 mb-6">
        Detalle del Evento
    </h1>

    <!-- Caja datos del evento -->
    <div id="infoEvento" class="bg-white p-6 rounded-xl shadow mb-6 text-gray-700">
        Cargando datos...
    </div>

    <!-- Caja detalle jugador -->
    <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold text-green-700 mb-4">
            Tu participación en este evento
        </h2>

        <div id="detalleJugador"></div>
    </div>

</main>

<script>
const eventoId = localStorage.getItem("eventoJugadorSeleccionado");
const jugadorId = localStorage.getItem("idJugador");

/* ============================================================
   Cargar datos del evento
============================================================ */
async function cargarEvento() {
    try {
        const res = await fetch(`${BASE_URL}/api/evento/${eventoId}`);
        const data = await res.json();

        if (!data || !data.evento) {
            document.getElementById("infoEvento").innerHTML =
                `<p class="text-red-600">No fue posible cargar la información.</p>`;
            return;
        }

        const e = data.evento;
        const asistencia = data.asistencia || [];

        const fecha = new Date(e.fechaEvento).toLocaleDateString("es-CL");

        document.getElementById("infoEvento").innerHTML = `
            <p><strong>Fecha:</strong> ${fecha}</p>
            <p><strong>Tipo:</strong> ${e.tipoEvento}</p>
            <p><strong>Categoría:</strong> ${e.categoria?.nombre || "-"}</p>
            <p><strong>Entrenador:</strong> ${e.entrenador?.nombre || "-"}</p>
        `;

        const registro = asistencia.find(a => a.jugador._id === jugadorId);

        if (!registro) {
            document.getElementById("detalleJugador").innerHTML =
                `<p class="text-gray-500">No existe registro de asistencia para este evento.</p>`;
            return;
        }

        mostrarDetalleJugador(registro);

    } catch (error) {
        document.getElementById("infoEvento").innerHTML =
            `<p class="text-red-600">Error al cargar el evento.</p>`;
    }
}

/* ============================================================
   Mostrar detalle del jugador
============================================================ */
function mostrarDetalleJugador(reg) {
    const presenteHTML = reg.presente
        ? `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">Asistió</span>`
        : `<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm">Ausente</span>`;

    document.getElementById("detalleJugador").innerHTML = `
        <div class="space-y-4">

            <div>
                <p class="font-semibold">Asistencia:</p>
                ${presenteHTML}
            </div>

            ${(!reg.presente && reg.motivoInasistencia) ? `
                <div>
                    <p class="font-semibold">Motivo de Inasistencia:</p>
                    <p>${reg.motivoInasistencia}</p>
                </div>
            ` : ""}

            <div>
                <p class="font-semibold">Observación del entrenador:</p>
                <p>${reg.observacion || "Sin observaciones"}</p>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm bg-gray-50 p-4 rounded-lg">

                <p><strong>Goles:</strong> ${reg.goles ?? 0}</p>
                <p><strong>Asistencias:</strong> ${reg.asistenciasGol ?? 0}</p>
                <p><strong>Pases clave:</strong> ${reg.pasesClave ?? 0}</p>
                <p><strong>Recuperaciones:</strong> ${reg.recuperaciones ?? 0}</p>
                <p><strong>Tiros al arco:</strong> ${reg.tirosArco ?? 0}</p>
                <p><strong>Faltas cometidas:</strong> ${reg.faltasCometidas ?? 0}</p>
                <p><strong>Faltas recibidas:</strong> ${reg.faltasRecibidas ?? 0}</p>
                <p><strong>Amarillas:</strong> ${reg.amarillas ?? 0}</p>
                <p><strong>Rojas:</strong> ${reg.rojas ?? 0}</p>

                <p class="col-span-2"><strong>Nota de rendimiento:</strong> 
                    ${reg.rendimiento ?? "No asignada"}
                </p>
            </div>

        </div>
    `;
}

cargarEvento();
</script>

</body>
</html>
