<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Rendimiento del Jugador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

<!-- VALIDACIÓN -->
<script>
if (!localStorage.getItem("token") || localStorage.getItem("rol") !== "apoderado") {
    window.location.href = "../index.html";
}
</script>

<script src="../js/config.js"></script>

<div class="p-8">

    <!-- BOTÓN VOLVER -->
    <button onclick="window.location.href='./jugador.html'"
            class="mb-4 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded shadow">
        ← Volver
    </button>

    <h1 class="text-3xl font-bold text-green-700 mb-2">Rendimiento del Jugador</h1>

    <p class="text-gray-600 mb-6">
        Jugador: <span id="nombreJugador"></span> • 
        Categoría: <span id="categoriaJugador"></span>
    </p>

    <!-- BOTONES PRINCIPALES -->
    <div class="flex gap-4 mb-6">
        <button id="btnCategoria" onclick="mostrarCategoria()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded shadow font-semibold">
            Rendimiento de la categoría
        </button>

        <button id="btnIndividual" onclick="mostrarIndividual()"
            class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded shadow font-semibold">
            Mi Estadística
        </button>
    </div>

    <!-- =======================
         SECCIÓN CATEGORÍA
    ======================== -->
    <div id="seccionCategoria" class="hidden">

        <h2 class="text-2xl font-bold text-green-700 mb-4">Rendimiento de la Categoría</h2>

        <p class="text-gray-600 mb-4">Resumen general de todos los jugadores de la categoría.</p>

        <div id="rendimientoCategoria" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    </div>

    <!-- =======================
         SECCIÓN INDIVIDUAL
    ======================== -->
    <div id="seccionIndividual" class="">

        <h2 class="text-2xl font-bold text-purple-700 mb-4">Mi Estadística Personal</h2>

        <!-- TARJETAS RESUMEN -->
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-5 mb-6">

            <!-- Asistencia -->
            <div class="p-4 bg-white rounded shadow border-l-8 border-green-600">
                <p class="text-2xl font-bold text-green-700" id="asistenciaTotal">0%</p>
                <p class="text-gray-600 text-sm">Asistencia total</p>
            </div>

            <!-- Goles -->
            <div class="p-4 bg-white rounded shadow border-l-8 border-blue-600">
                <p class="text-2xl font-bold text-blue-700" id="golesTotal">0</p>
                <p class="text-gray-600 text-sm">Goles totales</p>
            </div>

            <!-- Asistencias -->
            <div class="p-4 bg-white rounded shadow border-l-8 border-amber-600">
                <p class="text-2xl font-bold text-amber-700" id="asistenciasGol">0</p>
                <p class="text-gray-600 text-sm">Asistencias</p>
            </div>

            <!-- Amarillas -->
            <div class="p-4 bg-white rounded shadow border-l-8 border-purple-600">
                <p class="text-2xl font-bold text-purple-700" id="amarillas">0</p>
                <p class="text-gray-600 text-sm">Tarjetas Amarillas</p>
            </div>

            <!-- Rojas -->
            <div class="p-4 bg-white rounded shadow border-l-8 border-red-600">
                <p class="text-2xl font-bold text-red-700" id="rojas">0</p>
                <p class="text-gray-600 text-sm">Tarjetas Rojas</p>
            </div>

            <!-- Faltas -->
            <div class="p-4 bg-white rounded shadow border-l-8 border-gray-600">
                <p class="text-2xl font-bold text-gray-700" id="faltas">0</p>
                <p class="text-gray-600 text-sm">Faltas cometidas</p>
            </div>
        </div>

        <!-- TABLA DETALLE -->
        <h3 class="text-xl font-bold text-gray-700 mb-3">Detalle de tus participaciones</h3>

        <div class="bg-white shadow rounded p-3 overflow-x-auto">
            <table class="w-full min-w-[600px]">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-2">Fecha</th>
                        <th class="p-2">Evento</th>
                        <th class="p-2">Asistencia</th>
                        <th class="p-2">Goles</th>
                        <th class="p-2">Asist.</th>
                        <th class="p-2">Rend.</th>
                    </tr>
                </thead>
                <tbody id="tablaDetalle"></tbody>
            </table>
        </div>
    </div>

</div>

<!-- =======================
     SCRIPTS
======================= -->
<script>
const idJugador = localStorage.getItem("idJugador");
const nombreJugador = localStorage.getItem("nombreJugador");
const categoriaJugador = localStorage.getItem("categoriaJugador");

document.getElementById("nombreJugador").innerText = nombreJugador;
document.getElementById("categoriaJugador").innerText = localStorage.getItem("categoriaJugadorNombre") 
    || "Sin nombre";


/* =======================
   MOSTRAR SECCIONES
======================= */
function mostrarCategoria() {
    document.getElementById("seccionCategoria").classList.remove("hidden");
    document.getElementById("seccionIndividual").classList.add("hidden");
    cargarRendimientoCategoria();

    // Botones activos
    document.getElementById("btnCategoria").classList.add("scale-105");
    document.getElementById("btnIndividual").classList.remove("scale-105");
}

function mostrarIndividual() {
    document.getElementById("seccionIndividual").classList.remove("hidden");
    document.getElementById("seccionCategoria").classList.add("hidden");
    cargarEstadisticasJugador();

    document.getElementById("btnIndividual").classList.add("scale-105");
    document.getElementById("btnCategoria").classList.remove("scale-105");
}


/* =======================
   RENDIMIENTO CATEGORÍA
======================= */
async function cargarRendimientoCategoria() {
    const categoriaId = categoriaJugador;

    const res = await fetch(`http://localhost:3000/api/categoria/rendimiento/${categoriaId}`);
    const data = await res.json();

    const cont = document.getElementById("rendimientoCategoria");
    cont.innerHTML = "";

    data.forEach(item => {
        cont.innerHTML += `
            <div class="p-4 bg-white rounded shadow border-l-8 border-green-600">
                <p class="font-bold text-green-700 text-lg">${item.jugador}</p>
                <p class="text-sm text-gray-600">Asistencia: ${item.asistencia}%</p>
                <p class="text-sm text-gray-600">Goles: ${item.goles}</p>
                <p class="text-sm text-gray-600">Amarillas: ${item.amarillas}</p>
                <p class="text-sm text-gray-600">Rojas: ${item.rojas}</p>
            </div>`;
    });
}


/* =======================
   ESTADÍSTICA PERSONAL
======================= */
async function cargarEstadisticasJugador() {
    const res = await fetch(`http://localhost:3000/api/evento/jugador/${idJugador}/stats`);
    const stats = await res.json();

    document.getElementById("asistenciaTotal").innerText = stats.porcentaje + "%";
    document.getElementById("golesTotal").innerText = stats.goles;
    document.getElementById("asistenciasGol").innerText = stats.asistenciasGol;
    document.getElementById("amarillas").innerText = stats.amarillas;
    document.getElementById("rojas").innerText = stats.rojas;
    document.getElementById("faltas").innerText = stats.faltasCometidas;

    // Detalle tabla
    const detalle = await fetch(`http://localhost:3000/api/evento/jugador/${idJugador}`);
    const eventos = await detalle.json();

    let html = "";
    eventos.forEach(e => {
        html += `
            <tr class="border-b">
                <td class="p-2">${new Date(e.fecha).toLocaleDateString("es-CL")}</td>
                <td class="p-2">${e.tipo}</td>
                <td class="p-2">${e.presente ? "Asistió" : "Faltó"}</td>
                <td class="p-2">${e.goles}</td>
                <td class="p-2">${e.asistenciasGol}</td>
                <td class="p-2">${e.rendimiento ?? "-"}</td>
            </tr>
        `;
    });

    document.getElementById("tablaDetalle").innerHTML = html;
}

/* =======================
   MOSTRAR POR DEFECTO
======================= */
mostrarIndividual();
</script>

</body>
</html>
